/**
 * skylark-io-streams - The stream features enhancement for skylark utils.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark-langx/skylark","skylark-langx/langx","./streams","./decode-stream"],function(r,t,e,s){var i=s.inherit({klassName:"PredictorStream",_construct:function(r,t,e){if(!primitives.isDict(e))return r;var i=this.predictor=e.get("Predictor")||1;if(i<=1)return r;if(2!==i&&(i<10||i>15))throw new Error(`Unsupported predictor: ${i}`);this.readBlock=2===i?this.readBlockTiff:this.readBlockPng,this.str=r,this.dict=r.dict;var o=this.colors=e.get("Colors")||1,a=this.bits=e.get("BitsPerComponent")||8,f=this.columns=e.get("Columns")||1;return this.pixBytes=o*a+7>>3,this.rowBytes=f*o*a+7>>3,s.call(this,t),this},readBlockTiff:function(){var r=this.rowBytes,t=this.bufferLength,e=this.ensureBuffer(t+r),s=this.bits,i=this.colors,o=this.str.getBytes(r);if(this.eof=!o.length,!this.eof){var a,f=0,h=0,n=0,c=0,l=t;if(1===s&&1===i)for(a=0;a<r;++a){var u=o[a]^f;u^=u>>1,u^=u>>2,f=(1&(u^=u>>4))<<7,e[l++]=u}else if(8===s){for(a=0;a<i;++a)e[l++]=o[a];for(;a<r;++a)e[l]=e[l-i]+o[a],l++}else if(16===s){var d=2*i;for(a=0;a<d;++a)e[l++]=o[a];for(;a<r;a+=2){var g=((255&o[a])<<8)+(255&o[a+1])+((255&e[l-d])<<8)+(255&e[l-d+1]);e[l++]=g>>8&255,e[l++]=255&g}}else{var k=new Uint8Array(i+1),v=(1<<s)-1,B=0,y=t,b=this.columns;for(a=0;a<b;++a)for(var p=0;p<i;++p)n<s&&(f=f<<8|255&o[B++],n+=8),k[p]=k[p]+(f>>n-s)&v,n-=s,h=h<<s|k[p],(c+=s)>=8&&(e[y++]=h>>c-8&255,c-=8);c>0&&(e[y++]=(h<<8-c)+(f&(1<<8-c)-1))}this.bufferLength+=r}},readBlockPng:function(){var r=this.rowBytes,t=this.pixBytes,e=this.str.getByte(),s=this.str.getBytes(r);if(this.eof=!s.length,!this.eof){var i=this.bufferLength,o=this.ensureBuffer(i+r),a=o.subarray(i-r,i);0===a.length&&(a=new Uint8Array(r));var f,h,n,c=i;switch(e){case 0:for(f=0;f<r;++f)o[c++]=s[f];break;case 1:for(f=0;f<t;++f)o[c++]=s[f];for(;f<r;++f)o[c]=o[c-t]+s[f]&255,c++;break;case 2:for(f=0;f<r;++f)o[c++]=a[f]+s[f]&255;break;case 3:for(f=0;f<t;++f)o[c++]=(a[f]>>1)+s[f];for(;f<r;++f)o[c]=(a[f]+o[c-t]>>1)+s[f]&255,c++;break;case 4:for(f=0;f<t;++f)h=a[f],n=s[f],o[c++]=h+n;for(;f<r;++f){h=a[f];var l=a[f-t],u=o[c-t],d=u+h-l,g=d-u;g<0&&(g=-g);var k=d-h;k<0&&(k=-k);var v=d-l;v<0&&(v=-v),n=s[f],o[c++]=g<=k&&g<=v?u+n:k<=v?h+n:l+n}break;default:throw new Error(`Unsupported predictor: ${e}`)}this.bufferLength+=r}}});return e.PredictorStream=i});
//# sourceMappingURL=sourcemaps/predictor-stream.js.map
